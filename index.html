<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VATS AI Pro</title>

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<!-- Prism (syntax highlighter) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#05050f;
  --panel:#111122cc;
  --accent:#00e5ff;
  --text:#ffffff;
  --radius:12px;
  --shadow:0 0 30px rgba(0,229,255,.25);
  --transition-slow: 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  --transition-medium: 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  --transition-fast: 0.2s cubic-bezier(0.16, 1, 0.3, 1);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:var(--bg);color:var(--text);overflow-x:hidden}
canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1}

/* Robot floating above title */
#robot-container {
  position:fixed;top:12px;left:50%;transform:translateX(-50%);
  z-index:1002;filter:drop-shadow(0 0 8px var(--accent));
  width: 40px;height: 40px;
  animation: float 4s ease-in-out infinite, glow 3s ease-in-out infinite alternate;
}
#robot-canvas {
  width: 100%;height: 100%;
}
@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
@keyframes glow{from{filter:drop-shadow(0 0 8px var(--accent))}to{filter:drop-shadow(0 0 15px var(--accent))}}

/* Header */
header{position:fixed;top:0;left:0;width:100%;height:70px;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);background:#00000040;z-index:1001}
header h1{font-size:clamp(1.4rem,4vw,2.2rem);font-weight:900;background:linear-gradient(90deg,#00e5ff,#3fff88);-webkit-background-clip:text;background-clip:text;color:transparent;animation:glowTitle 3s ease-in-out infinite}
@keyframes glowTitle{from{text-shadow:0 0 10px var(--accent)}to{text-shadow:0 0 25px var(--accent),0 0 40px var(--accent)}}
#hamburger{
  position:fixed;left:16px;top:18px;z-index:1003;
  background:none;border:none;color:#fff;font-size:1.6rem;cursor:pointer;
  transition: transform var(--transition-fast);
}
#hamburger:hover {
  transform: scale(1.1);
}

/* Sidebar */
#sidebar{
  position:fixed;top:0;left:-280px;width:280px;max-width:85vw;height:100%;
  background:#0a0a1acc;backdrop-filter:blur(25px);
  border-right:1px solid #00e5ff33;z-index:1000;
  transition:left var(--transition-medium);display:flex;flex-direction:column;
}
#sidebar.open{left:0}
#sidebarHeader{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid #00e5ff33;
}
#sidebarHeader h2{font-size:1.1rem}
#closeSidebar{background:none;border:none;color:#fff;font-size:1.4rem;cursor:pointer;transition: transform var(--transition-fast);}
#closeSidebar:hover{transform: rotate(90deg);}
#searchContainer {
  padding: 10px;
  border-bottom: 1px solid #00e5ff33;
}
#searchInput {
  width: 100%;
  padding: 8px 12px;
  border-radius: var(--radius);
  background: rgba(255,255,255,.08);
  border: 1px solid #00e5ff33;
  color: #fff;
}
#searchInput:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 8px var(--accent);
}
#historyList{flex:1;overflow-y:auto;padding:8px}
.historyItem{
  padding:8px 10px;margin:4px 0;
  background:#111122;border-radius:var(--radius);
  cursor:pointer;font-size:.85rem;overflow:hidden;
  transition: all var(--transition-fast);
}
.historyItem:hover{background:#00e5ff33; transform: translateX(4px);}
.historyTitle {
  font-weight: bold;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.historyPreview {
  font-size: 0.75rem;
  opacity: 0.7;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Main */
main{max-width:100%;margin:80px auto 10px;padding:0 8px;display:flex;height:calc(100vh - 90px)}
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--panel);border:1px solid rgba(255,255,255,.05);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(15px);overflow:hidden}
.chat-header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#00000050;border-bottom:1px solid rgba(255,255,255,.05)}
.controls{display:flex;gap:8px}
.controls button{background:rgba(255,255,255,.08);border:none;width:36px;height:36px;border-radius:50%;color:#fff;cursor:pointer;transition:var(--transition-medium);display:grid;place-items:center}
.controls button:hover{background:var(--accent);box-shadow:0 0 15px var(--accent);transform:scale(1.12)}
.chat-history{flex:1;padding:10px;overflow-y:auto;scroll-behavior:smooth}
.message{margin-bottom:10px;padding:10px 12px;border-radius:var(--radius);max-width:85%;line-height:1.4;font-size:.95rem;animation:slideIn 0.5s var(--transition-slow) forwards;opacity:0;transform: translateY(20px);}
.user-message{background:rgba(0,229,255,.15);margin-left:auto;text-align:right;border:1px solid #00e5ff33}
.ai-message{background:rgba(63,255,136,.1);border:1px solid #3fff8833}
@keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes typewriter {
  from { width: 0; }
  to { width: 100%; }
}
.typing-indicator {
  display: inline-block;
  overflow: hidden;
  border-right: 2px solid var(--accent);
  white-space: nowrap;
  animation: typewriter 2s steps(40) forwards, blink 0.7s infinite;
}
@keyframes blink {
  from { border-color: transparent; }
  to { border-color: var(--accent); }
}
.input-area{display:flex;align-items:center;padding:10px;background:#00000050;border-top:1px solid rgba(255,255,255,.05)}
#userInput{flex:1;padding:12px;border:none;border-radius:var(--radius);background:rgba(255,255,255,.08);color:#fff;font-size:1rem;transition: var(--transition-medium);}
#userInput:focus{outline:none;background:rgba(255,255,255,.12);box-shadow:0 0 8px var(--accent)}
#sendBtn{
  background:linear-gradient(45deg,#ff00ff,#00e5ff,#3fff88);
  background-size:600% 600%;animation:rainbow 3s ease infinite;
  border:none;padding:12px 18px;border-radius:var(--radius);
  font-weight:700;color:#000;margin-left:8px;cursor:pointer;
  transition:var(--transition-medium);box-shadow:0 0 10px #ff00ff66;
}
#sendBtn:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 0 20px #00e5ff;}
#micBtn{background:rgba(255,255,255,.08);border:none;color:#fff;width:40px;height:40px;border-radius:50%;margin-left:6px;cursor:pointer;transition:var(--transition-medium);display:grid;place-items:center}
#micBtn.recording{background:#ff4c4c;animation:micPulse 1.2s infinite}
@keyframes micPulse{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}

/* Code blocks */
pre[class*="language-"]{border-radius:var(--radius);font-size:.8rem;margin:0 0 6px 0;position:relative;animation: slideIn 0.5s var(--transition-slow) forwards;}
.toolbar{
  position:absolute;top:4px;right:4px;display:flex;gap:4px;
}
.toolbar button{
  background:#00e5ff;color:#000;border:none;border-radius:4px;
  padding:3px 6px;font-size:.65rem;cursor:pointer;
  transition: var(--transition-fast);
}
.toolbar button:hover{filter:brightness(1.2); transform: translateY(-1px);}
.runBtn{background:#3fff88!important;color:#000!important}

/* Run modal */
#runModal{
  display:none;position:fixed;inset:0;background:#000c;z-index:9999;
  place-items:center;animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
#runFrame{width:95%;height:85%;border:none;border-radius:var(--radius);animation: scaleIn 0.3s ease;}
@keyframes scaleIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
#closeRun{
  position:absolute;top:12px;right:16px;background:#ff4c4c;color:#fff;border:none;border-radius:50%;width:40px;height:40px;font-size:1.2rem;cursor:pointer;
  transition: var(--transition-fast);
}
#closeRun:hover {
  transform: rotate(90deg);
}
</style>
</head>
<body>
<canvas id="spaceCanvas"></canvas>

<!-- Robot -->
<div id="robot-container">
  <canvas id="robot-canvas"></canvas>
</div>

<!-- Hamburger -->
<button id="hamburger"><i class="fas fa-bars"></i></button>

<!-- Sidebar -->
<div id="sidebar">
  <div id="sidebarHeader">
    <h2>History</h2>
    <button id="closeSidebar"><i class="fas fa-times"></i></button>
  </div>
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search conversations...">
  </div>
  <div id="historyList"></div>
</div>

<header>
  <h1>VATS AI Pro</h1>
</header>

<main>
  <section class="chat-area">
    <div class="chat-header">
      <span>VATS AI Assistant</span>
      <div class="controls">
        <button id="newChat" title="New chat"><i class="fas fa-plus"></i></button>
        <button id="fullScreen" title="Toggle fullscreen"><i class="fas fa-expand"></i></button>
        <button id="voiceToggle" title="Voice ON/OFF"><i class="fas fa-volume-up"></i></button>
      </div>
    </div>
    <div class="chat-history" id="chatHistory"></div>
    <div class="input-area">
      <input id="userInput" type="text" placeholder="Ask anythingâ€¦" autocomplete="off"/>
      <input id="fileInput" type="file" accept="image/*" style="display:none"/>
      <button id="attachBtn" title="Attach image"><i class="fas fa-image"></i></button>
      <button id="micBtn"><i class="fas fa-microphone"></i></button>
      <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </section>
</main>

<div id="runModal">
  <button id="closeRun"><i class="fas fa-times"></i></button>
  <iframe id="runFrame"></iframe>
</div>

<script>
/* ========= FIREBASE CONFIG ========= */
const firebaseConfig = {
  apiKey: "AIzaSyCfSlfHRqdGb__vTYZ9sEz9Cu1nTp_nG1A",
  authDomain: "vats-ai-2f5f6.firebaseapp.com",
  projectId: "vats-ai-2f5f6",
  storageBucket: "vats-ai-2f5f6.firebasestorage.app",
  messagingSenderId: "450902128843",
  appId: "1:450902128843:web:ea51590a23182d6024834e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const chatCol = db.collection('chatHistory');
const conversationsCol = db.collection('conversations');

/* ========= 3D BACKGROUND ========= */
const canvas=document.getElementById('spaceCanvas');
const renderer=new THREE.WebGLRenderer({canvas,alpha:true});
renderer.setSize(window.innerWidth,window.innerHeight);
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1000);
camera.position.z=30;
const starGeo=new THREE.BufferGeometry();
const starPos=new Float32Array(8000*3);
for(let i=0;i<starPos.length;i+=3){
  starPos[i]=(Math.random()-.5)*250;
  starPos[i+1]=(Math.random()-.5)*250;
  starPos[i+2]=(Math.random()-.5)*250;
}
starGeo.setAttribute('position',new THREE.BufferAttribute(starPos,3));
const starMat=new THREE.PointsMaterial({color:0x00e5ff,size:.12});
const stars=new THREE.Points(starGeo,starMat);
scene.add(stars);
function animate(){
  requestAnimationFrame(animate);
  stars.rotation.x+=.00025;stars.rotation.y+=.0003;
  renderer.render(scene,camera);
}
animate();
window.addEventListener('resize',()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});

/* ========= 3D ROBOT ========= */
const robotContainer = document.getElementById('robot-container');
const robotCanvas = document.getElementById('robot-canvas');
const robotRenderer = new THREE.WebGLRenderer({ canvas: robotCanvas, alpha: true });
robotRenderer.setSize(40, 40);
const robotScene = new THREE.Scene();
const robotCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
robotCamera.position.z = 5;

// Create a simple robot head
const headGeometry = new THREE.BoxGeometry(1, 1, 1);
const headMaterial = new THREE.MeshPhongMaterial({ 
  color: 0x00e5ff, 
  shininess: 100,
  specular: 0x3fff88
});
const head = new THREE.Mesh(headGeometry, headMaterial);
robotScene.add(head);

// Add eyes
const eyeGeometry = new THREE.SphereGeometry(0.15, 16, 16);
const eyeMaterial = new THREE.MeshBasicMaterial({ color: 0x3fff88 });
const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
leftEye.position.set(-0.3, 0.2, 0.5);
rightEye.position.set(0.3, 0.2, 0.5);
head.add(leftEye);
head.add(rightEye);

// Add antenna
const antennaGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.6);
const antennaMaterial = new THREE.MeshBasicMaterial({ color: 0xff00ff });
const antenna = new THREE.Mesh(antennaGeometry, antennaMaterial);
antenna.position.set(0, 0.8, 0);
head.add(antenna);

// Add light
const light = new THREE.PointLight(0xffffff, 1, 100);
light.position.set(2, 2, 5);
robotScene.add(light);
const ambientLight = new THREE.AmbientLight(0x404040);
robotScene.add(ambientLight);

// Add pulsing effect to antenna
const antennaLight = new THREE.PointLight(0xff00ff, 0.5, 2);
antennaLight.position.set(0, 1.1, 0);
antenna.add(antennaLight);

// Animation
function animateRobot() {
  requestAnimationFrame(animateRobot);
  head.rotation.y += 0.01;
  antenna.rotation.x = Math.sin(Date.now() * 0.005) * 0.1;
  antennaLight.intensity = 0.5 + Math.sin(Date.now() * 0.01) * 0.3;
  robotRenderer.render(robotScene, robotCamera);
}
animateRobot();

/* ========= SIDEBAR ========= */
const hamburger=document.getElementById('hamburger');
const sidebar=document.getElementById('sidebar');
const closeSidebar=document.getElementById('closeSidebar');
const historyList=document.getElementById('historyList');
const searchInput = document.getElementById('searchInput');

let currentConversationId = null;
let conversationMessages = [];

hamburger.onclick=()=>{
  if(sidebar.classList.contains('open')) {
    sidebar.classList.remove('open');
  } else {
    sidebar.classList.add('open');
    loadConversations();
  }
};
closeSidebar.onclick=()=>sidebar.classList.remove('open');

searchInput.addEventListener('input', (e) => {
  filterConversations(e.target.value);
});

function filterConversations(searchTerm) {
  const items = historyList.querySelectorAll('.historyItem');
  items.forEach(item => {
    const title = item.querySelector('.historyTitle').textContent.toLowerCase();
    const preview = item.querySelector('.historyPreview').textContent.toLowerCase();
    const searchLower = searchTerm.toLowerCase();
    
    if (title.includes(searchLower) || preview.includes(searchLower)) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });
}

function loadConversations(){
  historyList.innerHTML='';
  conversationsCol.orderBy('updatedAt','desc').get().then(snap=>{
    snap.forEach(doc=>{
      const conversation = doc.data();
      addConversationToSidebar(doc.id, conversation);
    });
    if(snap.empty){
      const none=document.createElement('div');
      none.textContent='No conversations yet';none.style.opacity='0.6';none.style.padding='10px';
      historyList.appendChild(none);
    }
  });
}

function addConversationToSidebar(id, conversation) {
  const div = document.createElement('div');
  div.className = 'historyItem';
  div.dataset.id = id;
  
  const titleDiv = document.createElement('div');
  titleDiv.className = 'historyTitle';
  titleDiv.textContent = conversation.title || 'Untitled Conversation';
  
  const previewDiv = document.createElement('div');
  previewDiv.className = 'historyPreview';
  previewDiv.textContent = conversation.preview || 'No messages yet';
  
  div.appendChild(titleDiv);
  div.appendChild(previewDiv);
  
  div.onclick = () => {
    sidebar.classList.remove('open');
    loadConversation(id);
  };
  
  historyList.appendChild(div);
}

function loadConversation(id) {
  conversationsCol.doc(id).get().then(doc => {
    if (doc.exists) {
      const conversation = doc.data();
      chatHistory.innerHTML = '';
      currentConversationId = id;
      
      // Load all messages from this conversation
      if (conversation.messages && conversation.messages.length > 0) {
        conversation.messages.forEach(msg => {
          addMsgToDom(msg.text, msg.isUser, false);
        });
      }
    }
  });
}

function updateConversation(message, isUser) {
  // If we don't have a conversation ID, create a new one
  if (!currentConversationId) {
    currentConversationId = conversationsCol.doc().id;
    
    // Create title from first message
    const title = message.length > 30 ? message.substring(0, 30) + 'Typing...' : message;
    
    // Create new conversation
    conversationsCol.doc(currentConversationId).set({
      title: title,
      preview: message,
      messages: [{ text: message, isUser: isUser }],
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      loadConversations(); // Refresh sidebar
    });
  } else {
    // Update existing conversation
    conversationsCol.doc(currentConversationId).get().then(doc => {
      if (doc.exists) {
        const conversation = doc.data();
        const messages = conversation.messages || [];
        messages.push({ text: message, isUser: isUser });
        
        // Update preview with the latest message
        const preview = message.length > 50 ? message.substring(0, 50) + 'Typing...' : message;
        
        conversationsCol.doc(currentConversationId).update({
          messages: messages,
          preview: preview,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          loadConversations(); // Refresh sidebar
        });
      }
    });
  }
}

/* ========= CHAT ========= */
const chatHistory=document.getElementById('chatHistory');
const userInput=document.getElementById('userInput');
const micBtn=document.getElementById('micBtn');
const sendBtn=document.getElementById('sendBtn');
const attachBtn=document.getElementById('attachBtn');
const fileInput=document.getElementById('fileInput');
const voiceToggle=document.getElementById('voiceToggle');
const runModal=document.getElementById('runModal');
const runFrame=document.getElementById('runFrame');
const closeRun=document.getElementById('closeRun');

let voiceOut=true;
let recognition,synth=speechSynthesis;

if('webkitSpeechRecognition' in window){
  recognition=new webkitSpeechRecognition();
  recognition.continuous=false;
  recognition.interimResults=true;
  recognition.lang='en-US';
  recognition.onstart=()=>{micBtn.classList.add('recording');micBtn.innerHTML='<i class="fas fa-stop"></i>';};
  recognition.onend=()=>{micBtn.classList.remove('recording');micBtn.innerHTML='<i class="fas fa-microphone"></i>';};
  recognition.onresult=e=>{
    let transcript='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      transcript+=e.results[i][0].transcript;
    }
    userInput.value=transcript;
    if(e.results[0].isFinal) sendMessage();
  };
}
micBtn.onclick=()=>recognition?.start();

function speak(text){
  if(!voiceOut||!('speechSynthesis' in window)) return;
  const cleaned=text
    .replace(/```[\s\S]*?```/g,'') // strip code blocks
    .replace(/[^\p{L}\p{N}\s]/gu,'') // letters, numbers, spaces only
    .trim();
  if(!cleaned) return;
  if(synth.speaking) synth.cancel();
  const utter=new SpeechSynthesisUtterance(cleaned);
  utter.rate=0.9;utter.pitch=1;utter.volume=1;utter.lang='en-US';
  synth.speak(utter);
}

function addMsgToDom(txt,isUser,save=true){
  const div=document.createElement('div');
  div.className='message '+(isUser?'user-message':'ai-message');
  
  if(save) {
    updateConversation(txt, isUser);
  }

  // For AI messages, add typing effect
  if(!isUser) {
    const typingSpan = document.createElement('span');
    typingSpan.className = 'typing-indicator';
    typingSpan.textContent = txt;
    typingSpan.style.width = '0';
    div.appendChild(typingSpan);
    
    // Animate typing effect
    setTimeout(() => {
      typingSpan.style.animation = `typewriter ${Math.min(3, txt.length/20)}s steps(${txt.length}) forwards, blink 0.7s infinite`;
    }, 100);
  } else {
    // For user messages, just show the text
    div.textContent = txt;
  }

  chatHistory.appendChild(div);
  chatHistory.scrollTop=chatHistory.scrollHeight;
  
  // For code highlighting, we'll need to re-process after the typing effect completes
  if(!isUser) {
    const typingTime = Math.min(3000, txt.length * 50);
    setTimeout(() => {
      highlightCode(div, txt);
    }, typingTime);
  } else {
    highlightCode(div, txt);
  }
}

function highlightCode(container, txt) {
  // Clear existing content
  container.innerHTML = '';
  
  /* Highlight code blocks */
  const codeRegex=/```(html|css|javascript|js|python)?\n([\s\S]*?)```/g;
  let lastIdx=0,match;
  while((match=codeRegex.exec(txt))!==null){
    const [full,lang,code]=match;
    if(match.index>lastIdx){
      container.appendChild(document.createTextNode(txt.slice(lastIdx,match.index)));
    }
    const pre=document.createElement('pre');
    const codeEl=document.createElement('code');
    codeEl.className='language-'+(lang||'');
    codeEl.textContent=code.trim();
    pre.appendChild(codeEl);

    const toolbar=document.createElement('div');
    toolbar.className='toolbar';

    const copyBtn=document.createElement('button');
    copyBtn.title='Copy';
    copyBtn.innerHTML='<i class="fas fa-copy"></i>';
    copyBtn.onclick=()=>navigator.clipboard.writeText(code.trim());
    toolbar.appendChild(copyBtn);

    if(['html','htm'].includes((lang||'').toLowerCase())){
      const runBtn=document.createElement('button');
      runBtn.title='Run';
      runBtn.className='runBtn';
      runBtn.innerHTML='<i class="fas fa-play"></i>';
      runBtn.onclick=()=>{
        runFrame.srcdoc=code.trim();
        runModal.style.display='grid';
      };
      toolbar.appendChild(runBtn);
    }
    pre.appendChild(toolbar);
    container.appendChild(pre);
    lastIdx=codeRegex.lastIndex;
  }
  if(lastIdx<txt.length){
    container.appendChild(document.createTextNode(txt.slice(lastIdx)));
  }
  Prism.highlightAllUnder(container);
}

async function sendMessage(){
  const txt=userInput.value.trim();
  if(!txt) return;
  addMsgToDom(txt,true);
  userInput.value='';
  
  // Show typing indicator
  const typingDiv = document.createElement('div');
  typingDiv.className = 'message ai-message';
  typingDiv.innerHTML = '<span class="typing-dots"><i class="fas fa-ellipsis-h"></i></span>';
  chatHistory.appendChild(typingDiv);
  chatHistory.scrollTop = chatHistory.scrollHeight;
  
  const ai=await getOpenRouterReply(txt);
  chatHistory.removeChild(typingDiv);
  addMsgToDom(ai,false);
  speak(ai);
}
sendBtn.onclick=sendMessage;
userInput.addEventListener('keydown',e=>{if(e.key==='Enter') sendMessage();});

async function getOpenRouterReply(message){
  const apiKey='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';
  const model='openai/gpt-oss-20b:free';
  try{
    const res=await fetch('https://openrouter.ai/api/v1/chat/completions',{
      method:'POST',
      headers:{
        'Authorization':`Bearer ${apiKey}`,
        'Content-Type':'application/json',
        'HTTP-Referer':location.href,
        'X-Title':'VATS AI'
      },
      body:JSON.stringify({
        model,
        messages:[
          {role:'system',content:'You are VATS, an advanced AI assistant. Reply naturally in English.'},
          ...Array.from(chatHistory.querySelectorAll('.message')).filter(msg => !msg.querySelector('.typing-dots')).map(el=>({role:el.classList.contains('user-message')?'user':'assistant',content:el.textContent})),
          {role:'user',content:message}
        ]
      })
    });
    const data=await res.json();
    return data.choices?.[0]?.message?.content||'No reply.';
  }catch(err){
    console.error(err);
    return 'Error contacting AI.';
  }
}

attachBtn.onclick=()=>fileInput.click();
fileInput.onchange=e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=document.createElement('img');
    img.src=ev.target.result;img.style.maxWidth='160px';img.style.borderRadius='var(--radius)';
    const msg=document.createElement('div');msg.className='message user-message';msg.appendChild(img);
    chatHistory.appendChild(msg);chatHistory.scrollTop=chatHistory.scrollHeight;
    addMsgToDom('Image uploaded. Vision analysis coming soon.',false);
  };
  reader.readAsDataURL(file);
};

document.getElementById('newChat').onclick=()=>{
  if(confirm('Start a new chat? Current chat will be cleared.')) {
    chatHistory.innerHTML='';
    currentConversationId = null;
    addMsgToDom('Fresh chat started.',false);
    speak('Fresh chat started.');
  }
};
document.getElementById('fullScreen').onclick=()=>document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();
voiceToggle.onclick=()=>{
  voiceOut=!voiceOut;
  voiceToggle.querySelector('i').className=voiceOut?'fas fa-volume-up':'fas fa-volume-mute';
  voiceToggle.style.background = voiceOut ? 'rgba(255,255,255,.08)' : 'rgba(255,0,0,0.2)';
};

closeRun.onclick=()=>{
  runModal.style.animation = 'fadeOut 0.3s ease';
  setTimeout(() => {
    runModal.style.display = 'none';
    runModal.style.animation = '';
  }, 300);
};
window.addEventListener('keydown',e=>{if(e.key==='Escape') runModal.style.display='none';});

/* Initial greeting */
setTimeout(() => {
  // Load the most recent conversation if available
  conversationsCol.orderBy('updatedAt', 'desc').limit(1).get().then(snap => {
    if (!snap.empty) {
      const doc = snap.docs[0];
      currentConversationId = doc.id;
      const conversation = doc.data();
      
      if (conversation.messages && conversation.messages.length > 0) {
        conversation.messages.forEach(msg => {
          addMsgToDom(msg.text, msg.isUser, false);
        });
      } else {
        addMsgToDom('Iâ€™m Vats AI, powered by Balaji ðŸ›¡\nAn AI assistant specialized in cybersecurity and coding â€” always ready to assist you.', false);
      }
    } else {
      addMsgToDom('Iâ€™m Vats AI, powered by Balaji ðŸ›¡\nAn AI assistant specialized in cybersecurity and coding â€” always ready to assist you.', false);
    }
  });
}, 500);
</script>
</body>
</html>